// prisma/schema-sqlite.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      String   @default("guru") // admin, guru
  nama      String
  email     String?
  status    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logActivities LogActivity[]
  guru          Guru?
  pengajuanDiproses PengajuanSiswa[]
}

model Siswa {
  id           Int      @id @default(autoincrement())
  nis          String   @unique
  nama         String
  jenisKelamin String?
  kelasId      Int
  tanggalLahir DateTime?
  alamat       String?
  noTelp       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  kelas     Kelas   @relation(fields: [kelasId], references: [id], onDelete: Cascade)
  absensis  Absensi[]
  pengajuanSiswa PengajuanSiswa[]
}

model Guru {
  id            Int    @id @default(autoincrement())
  kodeGuru      String @unique
  nama          String
  mataPelajaranId Int
  alamat        String?
  noTelp        String?
  userId        Int    @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  mataPelajaran MataPelajaran @relation(fields: [mataPelajaranId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  jadwals       Jadwal[]
  pengajuanDiajukan PengajuanSiswa[]
}

model Kelas {
  id          Int      @id @default(autoincrement())
  namaKelas   String
  tingkat     String   // X, XI, XII
  tahunAjaran String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  siswas    Siswa[]
  jadwals   Jadwal[]
  absensis  Absensi[]
  pengajuanAsal PengajuanSiswa[] @relation("KelasAsal")
  pengajuanTujuan PengajuanSiswa[] @relation("KelasTujuan")
}

model MataPelajaran {
  id        Int      @id @default(autoincrement())
  kodeMapel String   @unique
  namaMapel String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gurus   Guru[]
  jadwals Jadwal[]
}

model Jadwal {
  id              Int      @id @default(autoincrement())
  hari            String   // Senin, Selasa, dst
  jamMulai        String   // Format: HH:MM
  jamSelesai      String   // Format: HH:MM
  kelasId         Int
  guruId          Int
  mataPelajaranId Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  kelas         Kelas         @relation(fields: [kelasId], references: [id], onDelete: Cascade)
  guru          Guru          @relation(fields: [guruId], references: [id])
  mataPelajaran MataPelajaran @relation(fields: [mataPelajaranId], references: [id])
  absensis      Absensi[]
}

model Absensi {
  id              Int      @id @default(autoincrement())
  tanggal         DateTime
  status          String   // hadir, izin, sakit, alpha
  keterangan      String?
  siswaId         Int
  jadwalId        Int
  kelasId         Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  siswa   Siswa   @relation(fields: [siswaId], references: [id])
  jadwal  Jadwal  @relation(fields: [jadwalId], references: [id])
  kelas   Kelas   @relation(fields: [kelasId], references: [id], onDelete: Cascade)
}

model LogActivity {
  id          Int      @id @default(autoincrement())
  userId      Int
  activity    String
  detail      String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model PengajuanSiswa {
  id                  Int      @id @default(autoincrement())
  siswaId             Int
  kelasAsalId         Int
  kelasTujuanId       Int?     // Nullable if it's a removal request
  tipePengajuan       String   // 'pindah', 'hapus'
  alasan              String?
  status              String   @default("pending") // 'pending', 'diterima', 'ditolak'
  diajukanOlehGuruId  Int
  diprosesOlehAdminId Int?     // Nullable, filled when processed by admin
  tanggalPengajuan    DateTime @default(now())
  tanggalProses       DateTime?

  siswa         Siswa   @relation(fields: [siswaId], references: [id])
  kelasAsal     Kelas   @relation("KelasAsal", fields: [kelasAsalId], references: [id], onDelete: Cascade)
  kelasTujuan   Kelas?  @relation("KelasTujuan", fields: [kelasTujuanId], references: [id], onDelete: Cascade)
  diajukanOleh  Guru    @relation(fields: [diajukanOlehGuruId], references: [id])
  diprosesOleh  User?   @relation(fields: [diprosesOlehAdminId], references: [id])
}